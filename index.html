<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing SPC Monitoring System v2.3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .version {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        h1 {
            margin-bottom: 10px;
        }
        
        nav {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button.active {
            background: #764ba2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .view {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .view.active {
            display: block;
        }
        
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: #4CAF50;
        }
        
        .refresh-btn:hover {
            background: #45a049;
        }
        
        .sync-status {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }
        
        .sync-status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .inspector-section {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input:disabled, select:disabled, textarea:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .measurement-fields {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .measurement-group {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }
        
        .measurement-group.disabled {
            opacity: 0.6;
        }
        
        .measurement-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .measurement-header input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
            transform: scale(1.3);
        }
        
        .measurement-header label {
            margin: 0;
            cursor: pointer;
            font-size: 16px;
            color: #667eea;
        }
        
        .vibration-axes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .axis-group {
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            background: #fafafa;
        }
        
        .axis-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .axis-header input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .axis-header label {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }
        
        .sound-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .sound-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #fafafa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .sound-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .sound-checkbox label {
            margin: 0;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .sound-checkbox input:disabled + label {
            color: #999;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .chart-container {
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .fault-badge {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
        }
        
        .info-value {
            color: #333;
        }
        
        canvas {
            cursor: pointer;
        }
        
        .na-badge {
            background: #e0e0e0;
            color: #666;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="version">v2.3</div>
            <h1>Manufacturing SPC Monitoring System</h1>
            <p>Statistical Process Control & Equipment Monitoring</p>
        </header>
        
        <nav>
            <button onclick="showView('entry')" class="active" id="btn-entry">Inspection</button>
            <button onclick="showView('charts')" id="btn-charts">Control Charts</button>
            <button onclick="showView('log')" id="btn-log">Data Log</button>
        </nav>
        
        <div id="entry-view" class="view active">
            <h2>New Inspection Entry</h2>
            <div id="sync-status"></div>
            <div id="entry-alert"></div>
            
            <form id="inspection-form">
                <div class="inspector-section">
                    <h3>Inspector Information</h3>
                    <div class="form-group">
                        <label>Inspector Name *</label>
                        <input type="text" id="inspector-name" required placeholder="Enter your name">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Line *</label>
                    <select id="line" required onchange="updateDownlineOptions()">
                        <option value="">Select Line</option>
                        <option value="RX500">RX500</option>
                        <option value="RX300">RX300</option>
                        <option value="JBFlex">JBFlex</option>
                        <option value="L80">L80</option>
                        <option value="HH">HH</option>
                    </select>
                </div>
                
                <div class="form-group" id="downline-group" style="display: none;">
                    <label>Downline *</label>
                    <select id="downline" onchange="updateMachineOptions()">
                        <option value="">Select Downline</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Machine *</label>
                    <select id="machine" required>
                        <option value="">Select Machine</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Inspection Point *</label>
                    <input type="text" id="inspection-point" list="inspection-points-list" required placeholder="Type or select an inspection point">
                    <datalist id="inspection-points-list"></datalist>
                </div>
                
                <div class="measurement-fields" id="measurement-fields">
                    <h3>Select Measurements to Record</h3>
                    
                    <div class="measurement-group">
                        <div class="measurement-header">
                            <input type="checkbox" id="enable-temperature" onchange="toggleMeasurement('temperature')">
                            <label for="enable-temperature">Temperature</label>
                        </div>
                        <div class="form-group">
                            <label>Temperature (°F)</label>
                            <input type="number" step="0.1" id="temperature" disabled>
                        </div>
                    </div>
                    
                    <div class="measurement-group">
                        <div class="measurement-header">
                            <input type="checkbox" id="enable-vibration" onchange="toggleMeasurement('vibration')">
                            <label for="enable-vibration">Vibration</label>
                        </div>
                        <div class="vibration-axes">
                            <div class="axis-group">
                                <div class="axis-header">
                                    <input type="checkbox" id="enable-vibration-x" disabled onchange="toggleAxis('x')">
                                    <label for="enable-vibration-x">X-Axis</label>
                                </div>
                                <input type="number" step="0.01" id="vibration-x" placeholder="mm/s" disabled>
                            </div>
                            <div class="axis-group">
                                <div class="axis-header">
                                    <input type="checkbox" id="enable-vibration-y" disabled onchange="toggleAxis('y')">
                                    <label for="enable-vibration-y">Y-Axis</label>
                                </div>
                                <input type="number" step="0.01" id="vibration-y" placeholder="mm/s" disabled>
                            </div>
                            <div class="axis-group">
                                <div class="axis-header">
                                    <input type="checkbox" id="enable-vibration-z" disabled onchange="toggleAxis('z')">
                                    <label for="enable-vibration-z">Z-Axis</label>
                                </div>
                                <input type="number" step="0.01" id="vibration-z" placeholder="mm/s" disabled>
                            </div>
                        </div>
                    </div>
                    
                    <div class="measurement-group">
                        <div class="measurement-header">
                            <input type="checkbox" id="enable-auditory" onchange="toggleMeasurement('auditory')">
                            <label for="enable-auditory">Auditory (Sound)</label>
                        </div>
                        <div class="sound-checkboxes">
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-grinding" disabled>
                                <label for="sound-grinding">Grinding</label>
                            </div>
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-scratching" disabled>
                                <label for="sound-scratching">Scratching</label>
                            </div>
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-squealing" disabled>
                                <label for="sound-squealing">Squealing</label>
                            </div>
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-clicking" disabled>
                                <label for="sound-clicking">Clicking</label>
                            </div>
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-rattling" disabled>
                                <label for="sound-rattling">Rattling</label>
                            </div>
                            <div class="sound-checkbox">
                                <input type="checkbox" id="sound-humming" disabled>
                                <label for="sound-humming">Abnormal Humming</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="measurement-group">
                        <div class="measurement-header">
                            <input type="checkbox" id="enable-tack-rpm" onchange="toggleMeasurement('tack-rpm')">
                            <label for="enable-tack-rpm">Tack RPM</label>
                        </div>
                        <div class="form-group">
                            <label>Tack RPM</label>
                            <input type="number" step="1" id="tack-rpm" disabled>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" placeholder="Enter any observations or notes..."></textarea>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit">Submit Inspection</button>
                    <button type="button" class="btn-secondary" onclick="submitAndContinue()">Submit & Add Another Inspection</button>
                    <button type="button" class="btn-secondary" onclick="newMachine()">New Machine</button>
                </div>
            </form>
        </div>
        
        <div id="charts-view" class="view">
            <div class="view-header">
                <h2>Control Charts</h2>
                <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
            </div>
            <div id="charts-sync-status"></div>
            
            <div class="filters">
                <div>
                    <label>Filter by Line</label>
                    <select id="filter-line" onchange="renderCharts()">
                        <option value="">All Lines</option>
                    </select>
                </div>
                
                <div>
                    <label>Filter by Downline</label>
                    <select id="filter-downline" onchange="renderCharts()">
                        <option value="">All Downlines</option>
                    </select>
                </div>
                
                <div>
                    <label>Filter by Machine</label>
                    <select id="filter-machine" onchange="renderCharts()">
                        <option value="">All Machines</option>
                    </select>
                </div>
                
                <div>
                    <label>Filter by Inspection Point</label>
                    <select id="filter-point" onchange="renderCharts()">
                        <option value="">All Points</option>
                    </select>
                </div>
            </div>
            
            <div id="charts-container"></div>
        </div>
        
        <div id="log-view" class="view">
            <div class="view-header">
                <h2>Inspection Data Log</h2>
                <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
            </div>
            <div id="log-sync-status"></div>
            <div id="log-container"></div>
        </div>
    </div>
    
    <div id="point-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Inspection Details</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
            <div class="form-group" style="margin-top: 20px;">
                <label>Add Additional Notes</label>
                <textarea id="additional-notes"></textarea>
            </div>
            <button onclick="saveAdditionalNotes()">Save Notes</button>
        </div>
    </div>
    
    <script>
        // Configuration - PASTE YOUR GOOGLE APPS SCRIPT URL HERE
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkmTzohbjm7jRmWmgeU4Zrzp373qBJovncVA1jrK2K5glnVANUX4R6tUwl2vJSvijBVA/exec';
        
        // Data structure
        let inspections = [];
        let customInspectionPoints = {}; 
        let currentPointId = null;
        
        const rx500DownlineMachines = ['Ilapak', 'Case Erector', 'Ilapak', 'Palletizer'];
        const lineConfig = {
            'RX500': {
                downlines: ['Clipper', '501', '502', '503', '504', '505'],
                machines: {
                    'Clipper': ['Diverter', 'Blending Skid', 'Saw House', 'Splicing', 'Wetting system', 'Forming table'],
                    '501': rx500DownlineMachines,
                    '502': rx500DownlineMachines,
                    '503': rx500DownlineMachines,
                    '504': rx500DownlineMachines,
                    '505': rx500DownlineMachines
                }
            },
            'RX300': { downlines: [], machines: {} },
            'JBFlex': { downlines: [], machines: {} },
            'L80': { downlines: [], machines: {} },
            'HH': { downlines: [], machines: {} }
        };
        
        function updateDownlineOptions() {
            const line = document.getElementById('line').value;
            const downlineGroup = document.getElementById('downline-group');
            const downlineSelect = document.getElementById('downline');
            const machineSelect = document.getElementById('machine');
            
            if (line && lineConfig[line].downlines.length > 0) {
                downlineGroup.style.display = 'block';
                downlineSelect.required = true;
                downlineSelect.innerHTML = '<option value="">Select Downline</option>' +
                    lineConfig[line].downlines.map(d => `<option value="${d}">${d}</option>`).join('');
            } else {
                downlineGroup.style.display = 'none';
                downlineSelect.required = false;
                downlineSelect.value = '';
            }
            
            machineSelect.innerHTML = '<option value="">Select Machine</option>';
            updateMachineOptions(); 
        }
        
        function updateMachineOptions() {
            const line = document.getElementById('line').value;
            const downline = document.getElementById('downline').value;
            const machineSelect = document.getElementById('machine');
            
            if (line && downline && lineConfig[line].machines[downline]) {
                const machines = lineConfig[line].machines[downline];
                machineSelect.innerHTML = '<option value="">Select Machine</option>' +
                    machines.map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                machineSelect.innerHTML = '<option value="">Select Machine</option>';
            }
            updateInspectionPointOptions(); 
        }

        function loadCustomInspectionPoints() {
            const stored = localStorage.getItem('spcCustomInspectionPoints');
            if (stored) {
                customInspectionPoints = JSON.parse(stored);
            }
        }

        function saveCustomInspectionPoints() {
            localStorage.setItem('spcCustomInspectionPoints', JSON.stringify(customInspectionPoints));
        }

        function updateInspectionPointOptions() {
            const line = document.getElementById('line').value;
            const downline = document.getElementById('downline').value;
            const machine = document.getElementById('machine').value;
            const datalist = document.getElementById('inspection-points-list');
            datalist.innerHTML = ''; 

            if (!line || !machine) return; 

            const key = `${line}-${downline || 'none'}-${machine}`;
            const customPoints = customInspectionPoints[key] || [];
            
            const allPoints = ['Point 1', ...customPoints];
            const uniquePoints = [...new Set(allPoints)];

            uniquePoints.forEach(point => {
                const option = document.createElement('option');
                option.value = point;
                datalist.appendChild(option);
            });
        }
        
        function syncToCloud(inspection) {
            return new Promise((resolve) => {
                showSyncStatus('syncing', 'Syncing to cloud...');
                
                try {
                    let iframe = document.getElementById('sync-iframe');
                    if (!iframe) {
                        iframe = document.createElement('iframe');
                        iframe.id = 'sync-iframe';
                        iframe.name = 'sync-iframe';
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                    }
                    
                    let form = document.getElementById('sync-form');
                    if (form) form.remove();
                    
                    form = document.createElement('form');
                    form.id = 'sync-form';
                    form.method = 'POST';
                    form.action = GOOGLE_SCRIPT_URL;
                    form.target = 'sync-iframe';
                    form.style.display = 'none';
                    
                    const actionInput = document.createElement('input');
                    actionInput.type = 'hidden';
                    actionInput.name = 'action';
                    actionInput.value = 'save';
                    form.appendChild(actionInput);
                    
                    const inspectionInput = document.createElement('input');
                    inspectionInput.type = 'hidden';
                    inspectionInput.name = 'inspection';
                    inspectionInput.value = JSON.stringify(inspection);
                    form.appendChild(inspectionInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                    
                    setTimeout(() => {
                        showSyncStatus('success', '✓ Synced to cloud successfully');
                        console.log('Synced inspection:', inspection.id);
                        setTimeout(() => showSyncStatus('', ''), 3000);
                        resolve(true);
                    }, 1000);
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    showSyncStatus('error', '✗ Cloud sync failed - data saved locally');
                    setTimeout(() => showSyncStatus('', ''), 5000);
                    resolve(false);
                }
            });
        }
        
        async function refreshData() {
            const currentView = document.querySelector('.view.active').id;
            const statusDiv = currentView === 'charts-view' ? 'charts-sync-status' : 'log-sync-status';
            
            showSyncStatus('syncing', 'Refreshing from cloud...', statusDiv);
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                if (data.success && data.inspections) {
                    inspections = data.inspections;
                    saveData(); 
                    
                    if (currentView === 'charts-view') {
                        populateFilters();
                        renderCharts();
                    } else if (currentView === 'log-view') {
                        renderLog();
                    }
                    
                    showSyncStatus('success', '✓ Data refreshed successfully', statusDiv);
                } else {
                    throw new Error('Invalid response from server');
                }
            } catch (error) {
                console.error('Refresh error:', error);
                showSyncStatus('error', '✗ Failed to refresh from cloud', statusDiv);
            }
            
            setTimeout(() => showSyncStatus('', '', statusDiv), 3000);
        }
        
        function showSyncStatus(type, message, divId = 'sync-status') {
            const statusDiv = document.getElementById(divId);
            if (!message) {
                statusDiv.innerHTML = '';
                return;
            }
            statusDiv.innerHTML = `<div class="sync-status ${type}">${message}</div>`;
        }
        
        function loadData() {
            const stored = localStorage.getItem('spcInspections');
            if (stored) {
                inspections = JSON.parse(stored);
            }
        }
        
        function saveData() {
            localStorage.setItem('spcInspections', JSON.stringify(inspections));
        }
        
        loadData();
        loadCustomInspectionPoints(); 
        
        function toggleMeasurement(type) {
            const checkbox = document.getElementById(`enable-${type}`);
            
            if (type === 'vibration') {
                const xCheck = document.getElementById('enable-vibration-x');
                const yCheck = document.getElementById('enable-vibration-y');
                const zCheck = document.getElementById('enable-vibration-z');
                
                xCheck.disabled = !checkbox.checked;
                yCheck.disabled = !checkbox.checked;
                zCheck.disabled = !checkbox.checked;
                
                if (!checkbox.checked) {
                    xCheck.checked = false;
                    yCheck.checked = false;
                    zCheck.checked = false;
                    document.getElementById('vibration-x').disabled = true;
                    document.getElementById('vibration-y').disabled = true;
                    document.getElementById('vibration-z').disabled = true;
                }
            } else if (type === 'auditory') {
                const sounds = ['grinding', 'scratching', 'squealing', 'clicking', 'rattling', 'humming'];
                sounds.forEach(sound => {
                    const soundCheck = document.getElementById(`sound-${sound}`);
                    soundCheck.disabled = !checkbox.checked;
                    if (!checkbox.checked) {
                        soundCheck.checked = false;
                    }
                });
            } else {
                const input = document.getElementById(type);
                input.disabled = !checkbox.checked;
                if (!checkbox.checked) {
                    input.value = '';
                }
            }
        }
        
        function toggleAxis(axis) {
            const checkbox = document.getElementById(`enable-vibration-${axis}`);
            const input = document.getElementById(`vibration-${axis}`);
            input.disabled = !checkbox.checked;
            if (!checkbox.checked) {
                input.value = '';
            }
        }
        
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${viewName}-view`).classList.add('active');
            document.getElementById(`btn-${viewName}`).classList.add('active');
            
            if (viewName === 'charts') {
                populateFilters();
                renderCharts();
            } else if (viewName === 'log') {
                renderLog();
            }
        }
        
        async function submitInspection(keepContext = false) {
            const form = document.getElementById('inspection-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            
            const downlineValue = document.getElementById('downline-group').style.display === 'none' 
                ? null 
                : document.getElementById('downline').value;

            const inspectionPointValue = document.getElementById('inspection-point').value.trim();
            if (!inspectionPointValue) {
                alert('Inspection Point is required.');
                return false;
            }
            
            const inspection = {
                id: Date.now().toString(),
                inspector: document.getElementById('inspector-name').value,
                line: document.getElementById('line').value,
                downline: downlineValue,
                machine: document.getElementById('machine').value,
                inspectionPoint: inspectionPointValue,
                measurements: {},
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString(),
                history: [{
                    action: 'created',
                    timestamp: new Date().toISOString()
                }]
            };

            const key = `${inspection.line}-${inspection.downline || 'none'}-${inspection.machine}`;
            if (!customInspectionPoints[key]) {
                customInspectionPoints[key] = [];
            }
            const knownPoints = ['Point 1', ...customInspectionPoints[key]];
            if (!knownPoints.includes(inspectionPointValue)) {
                customInspectionPoints[key].push(inspectionPointValue);
                saveCustomInspectionPoints();
                updateInspectionPointOptions(); 
            }
            
            if (document.getElementById('enable-temperature').checked) {
                inspection.measurements.temperature = parseFloat(document.getElementById('temperature').value);
            }
            
            if (document.getElementById('enable-vibration').checked) {
                inspection.measurements.vibration = {};
                if (document.getElementById('enable-vibration-x').checked) {
                    inspection.measurements.vibration.x = parseFloat(document.getElementById('vibration-x').value);
                }
                if (document.getElementById('enable-vibration-y').checked) {
                    inspection.measurements.vibration.y = parseFloat(document.getElementById('vibration-y').value);
                }
                if (document.getElementById('enable-vibration-z').checked) {
                    inspection.measurements.vibration.z = parseFloat(document.getElementById('vibration-z').value);
                }
            }
            
            if (document.getElementById('enable-auditory').checked) {
                inspection.measurements.auditory = [];
                const sounds = ['grinding', 'scratching', 'squealing', 'clicking', 'rattling', 'humming'];
                sounds.forEach(sound => {
                    if (document.getElementById(`sound-${sound}`).checked) {
                        inspection.measurements.auditory.push(sound);
                    }
                });
            }
            
            if (document.getElementById('enable-tack-rpm').checked) {
                inspection.measurements.tackRPM = parseFloat(document.getElementById('tack-rpm').value);
            }
            
            if (Object.keys(inspection.measurements).length === 0) {
                alert('Please select and enter at least one measurement type.');
                return false;
            }
            
            inspections.push(inspection);
            saveData();
            
            await syncToCloud(inspection);
            
            const faults = checkForFaults(inspection);
            
            let alertHtml = '<div class="alert alert-success">Inspection submitted successfully!</div>';
            if (faults.length > 0) {
                alertHtml += '<div class="alert alert-danger"><strong>⚠️ Control Chart Faults Detected!</strong><br>' +
                    faults.map(f => `${f.type}: ${f.description}`).join('<br>') +
                    '<br><br><strong>Action Required: Create work order</strong></div>';
            }
            
            document.getElementById('entry-alert').innerHTML = alertHtml;
            setTimeout(() => {
                document.getElementById('entry-alert').innerHTML = '';
            }, 5000);
            
            if (keepContext) {
                const inspectorName = document.getElementById('inspector-name').value;
                const line = document.getElementById('line').value;
                const downline = document.getElementById('downline').value;
                const machine = document.getElementById('machine').value;
                
                form.reset();
                
                document.getElementById('inspector-name').value = inspectorName;
                document.getElementById('line').value = line;
                updateDownlineOptions();
                if (downline) {
                    document.getElementById('downline').value = downline;
                    updateMachineOptions();
                }
                document.getElementById('machine').value = machine;
                
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('#measurement-fields input[type="number"]').forEach(inp => {
                    inp.disabled = true;
                    inp.value = '';
                });
                document.querySelectorAll('.sound-checkbox input').forEach(inp => {
                    inp.disabled = true;
                    inp.checked = false;
                });
            } else {
                // FIXED: This block now correctly resets the form without disabling the inspection point input.
                form.reset();
                document.getElementById('downline-group').style.display = 'none';
                updateInspectionPointOptions();

                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                
                document.querySelectorAll('#measurement-fields input[type="number"]').forEach(inp => {
                    inp.disabled = true;
                    inp.value = '';
                });
                
                document.querySelectorAll('.sound-checkbox input').forEach(inp => {
                    inp.disabled = true;
                    inp.checked = false;
                });
            }
            
            return true;
        }
        
        document.getElementById('inspection-form').addEventListener('submit', function(e) {
            e.preventDefault();
            submitInspection(false);
        });
        
        function submitAndContinue() {
            submitInspection(true);
        }
        
        function newMachine() {
            const form = document.getElementById('inspection-form');
            const inspectorName = document.getElementById('inspector-name').value;
            
            form.reset();
            document.getElementById('inspector-name').value = inspectorName;
            document.getElementById('downline-group').style.display = 'none';
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#measurement-fields input[type="number"]').forEach(inp => {
                inp.disabled = true;
                inp.value = '';
            });
            document.querySelectorAll('.sound-checkbox input').forEach(inp => {
                inp.disabled = true;
                inp.checked = false;
            });
        }
        
        function checkForFaults(newInspection) {
            const faults = [];
            const key = `${newInspection.line}-${newInspection.downline || ''}-${newInspection.machine}-${newInspection.inspectionPoint}`;
            const history = inspections.filter(i => 
                i.line === newInspection.line &&
                (i.downline || '') === (newInspection.downline || '') &&
                i.machine === newInspection.machine &&
                i.inspectionPoint === newInspection.inspectionPoint
            );
            
            if (history.length < 3) return faults;
            
            if (newInspection.measurements.temperature !== undefined) {
                checkMeasurementFaults('Temperature', 'temperature', history, newInspection, faults);
            }
            
            if (newInspection.measurements.vibration) {
                ['x', 'y', 'z'].forEach(axis => {
                    if (newInspection.measurements.vibration[axis] !== undefined) {
                        checkMeasurementFaults(`Vibration ${axis.toUpperCase()}`, `vibration.${axis}`, history, newInspection, faults);
                    }
                });
            }
            
            if (newInspection.measurements.tackRPM !== undefined) {
                checkMeasurementFaults('Tack RPM', 'tackRPM', history, newInspection, faults);
            }
            
            return faults;
        }
        
        function checkMeasurementFaults(label, path, history, newInspection, faults) {
            const getValue = (obj, path) => {
                return path.split('.').reduce((o, p) => o?.[p], obj.measurements);
            };
            
            const values = history
                .map(i => getValue(i, path))
                .filter(v => v !== undefined);
            
            if (values.length < 3) return;
            
            const mean = values.reduce((a, b) => a + b) / values.length;
            const stdDev = Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / values.length);
            
            const latest = getValue(newInspection, path);
            
            if (Math.abs(latest - mean) > 3 * stdDev) {
                faults.push({
                    type: 'Rule 1',
                    description: `${label}: Point beyond 3 sigma (${latest.toFixed(2)})`
                });
            }
            
            if (values.length >= 9) {
                const last9 = values.slice(-9);
                const allAbove = last9.every(v => v > mean);
                const allBelow = last9.every(v => v < mean);
                if (allAbove || allBelow) {
                    faults.push({
                        type: 'Rule 2',
                        description: `${label}: 9 points in a row on same side of mean`
                    });
                }
            }
            
            if (values.length >= 6) {
                const last6 = values.slice(-6);
                let increasing = true, decreasing = true;
                for (let i = 1; i < last6.length; i++) {
                    if (last6[i] <= last6[i-1]) increasing = false;
                    if (last6[i] >= last6[i-1]) decreasing = false;
                }
                if (increasing || decreasing) {
                    faults.push({
                        type: 'Rule 3',
                        description: `${label}: 6 points steadily ${increasing ? 'increasing' : 'decreasing'}`
                    });
                }
            }
            
            if (values.length >= 3) {
                const last3 = values.slice(-3);
                const beyond2Sigma = last3.filter(v => Math.abs(v - mean) > 2 * stdDev).length;
                if (beyond2Sigma >= 2) {
                    faults.push({
                        type: 'Rule 5',
                        description: `${label}: 2 out of 3 points beyond 2 sigma`
                    });
                }
            }
            
            if (values.length >= 5) {
                const last5 = values.slice(-5);
                const beyond1Sigma = last5.filter(v => Math.abs(v - mean) > stdDev).length;
                if (beyond1Sigma >= 4) {
                    faults.push({
                        type: 'Rule 6',
                        description: `${label}: 4 out of 5 points beyond 1 sigma`
                    });
                }
            }
        }
        
        function populateFilters() {
            const lines = [...new Set(inspections.map(i => i.line))];
            const downlines = [...new Set(inspections.map(i => i.downline).filter(d => d))];
            const machines = [...new Set(inspections.map(i => i.machine))];
            const points = [...new Set(inspections.map(i => i.inspectionPoint))];
            
            const lineFilter = document.getElementById('filter-line');
            const downlineFilter = document.getElementById('filter-downline');
            const machineFilter = document.getElementById('filter-machine');
            const pointFilter = document.getElementById('filter-point');
            
            lineFilter.innerHTML = '<option value="">All Lines</option>' + 
                lines.map(l => `<option value="${l}">${l}</option>`).join('');
            
            downlineFilter.innerHTML = '<option value="">All Downlines</option>' + 
                downlines.map(d => `<option value="${d}">${d}</option>`).join('');
            
            machineFilter.innerHTML = '<option value="">All Machines</option>' + 
                machines.map(m => `<option value="${m}">${m}</option>`).join('');
            
            pointFilter.innerHTML = '<option value="">All Points</option>' + 
                points.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        
        function renderCharts() {
            const container = document.getElementById('charts-container');
            container.innerHTML = '';
            
            const filterLine = document.getElementById('filter-line').value;
            const filterDownline = document.getElementById('filter-downline').value;
            const filterMachine = document.getElementById('filter-machine').value;
            const filterPoint = document.getElementById('filter-point').value;
            
            let filtered = inspections.filter(i => {
                return (!filterLine || i.line === filterLine) &&
                       (!filterDownline || i.downline === filterDownline) &&
                       (!filterMachine || i.machine === filterMachine) &&
                       (!filterPoint || i.inspectionPoint === filterPoint);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p>No data available for the selected filters.</p>';
                return;
            }
            
            const groups = {};
            filtered.forEach(i => {
                const key = `${i.line}${i.downline ? ' - ' + i.downline : ''} - ${i.machine} - ${i.inspectionPoint}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(i);
            });
            
            Object.keys(groups).forEach(key => {
                const data = groups[key].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                if (data.some(d => d.measurements.temperature !== undefined)) {
                    createControlChart(key, 'temperature', 'Temperature (°F)', data, container);
                }
                
                ['x', 'y', 'z'].forEach(axis => {
                    if (data.some(d => d.measurements.vibration?.[axis] !== undefined)) {
                        createControlChart(key, `vibration.${axis}`, `Vibration ${axis.toUpperCase()} (mm/s)`, data, container);
                    }
                });
                
                if (data.some(d => d.measurements.tackRPM !== undefined)) {
                    createControlChart(key, 'tackRPM', 'Tack RPM', data, container);
                }
            });
        }
        
        function createControlChart(title, measurePath, measureLabel, data, container) {
            const getValue = (obj) => {
                return measurePath.split('.').reduce((o, p) => o?.[p], obj.measurements);
            };
            
            const allData = data.map((d, i) => ({
                value: getValue(d),
                timestamp: new Date(d.timestamp).toLocaleString(),
                index: i,
                inspection: d
            })).filter(d => d.value !== undefined);
            
            if (allData.length === 0) return;
            
            const values = allData.map(d => d.value);
            const timestamps = allData.map(d => d.timestamp);
            
            const mean = values.reduce((a, b) => a + b) / values.length;
            const stdDev = Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / values.length);
            
            const ucl = mean + 3 * stdDev;
            const lcl = mean - 3 * stdDev;
            const uwl = mean + 2 * stdDev;
            const lwl = mean - 2 * stdDev;
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            
            const hasFaults = values.some(v => Math.abs(v - mean) > 3 * stdDev);
            
            const chartId = `chart-${measurePath.replace(/\./g, '-')}-${title.replace(/\s/g, '-')}`;
            chartDiv.innerHTML = `
                <div class="chart-header">
                    <div class="chart-title">${title} - ${measureLabel}</div>
                    ${hasFaults ? '<div class="fault-badge">⚠️ Fault Detected</div>' : ''}
                </div>
                <canvas id="${chartId}"></canvas>
            `;
            
            container.appendChild(chartDiv);
            
            const ctx = chartDiv.querySelector('canvas').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: measureLabel,
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.1,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Mean',
                            data: Array(values.length).fill(mean),
                            borderColor: '#4CAF50',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'UCL (3σ)',
                            data: Array(values.length).fill(ucl),
                            borderColor: '#f44336',
                            borderDash: [10, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'LCL (3σ)',
                            data: Array(values.length).fill(lcl),
                            borderColor: '#f44336',
                            borderDash: [10, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'UWL (2σ)',
                            data: Array(values.length).fill(uwl),
                            borderColor: '#ff9800',
                            borderDash: [5, 5],
                            pointRadius: 0
                        },
                        {
                            label: 'LWL (2σ)',
                            data: Array(values.length).fill(lwl),
                            borderColor: '#ff9800',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            showPointDetails(allData[index].inspection);
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        function showPointDetails(point) {
            currentPointId = point.id;
            const modal = document.getElementById('point-modal');
            const body = document.getElementById('modal-body');
            
            let html = `
                <div class="info-row">
                    <span class="info-label">Inspector:</span>
                    <span class="info-value">${point.inspector}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Line:</span>
                    <span class="info-value">${point.line}</span>
                </div>
            `;
            
            if (point.downline) {
                html += `
                    <div class="info-row">
                        <span class="info-label">Downline:</span>
                        <span class="info-value">${point.downline}</span>
                    </div>
                `;
            }
            
            html += `
                <div class="info-row">
                    <span class="info-label">Machine:</span>
                    <span class="info-value">${point.machine}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Inspection Point:</span>
                    <span class="info-value">${point.inspectionPoint}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Timestamp:</span>
                    <span class="info-value">${new Date(point.timestamp).toLocaleString()}</span>
                </div>
            `;
            
            if (point.measurements.temperature !== undefined) {
                html += `
                    <div class="info-row">
                        <span class="info-label">Temperature:</span>
                        <span class="info-value">${point.measurements.temperature} °F</span>
                    </div>
                `;
            }
            
            if (point.measurements.vibration) {
                ['x', 'y', 'z'].forEach(axis => {
                    if (point.measurements.vibration[axis] !== undefined) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Vibration ${axis.toUpperCase()}:</span>
                                <span class="info-value">${point.measurements.vibration[axis]} mm/s</span>
                            </div>
                        `;
                    }
                });
            }
            
            if (point.measurements.auditory && point.measurements.auditory.length > 0) {
                html += `
                    <div class="info-row">
                        <span class="info-label">Auditory (Sounds):</span>
                        <span class="info-value">${point.measurements.auditory.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ')}</span>
                    </div>
                `;
            }
            
            if (point.measurements.tackRPM !== undefined) {
                html += `
                    <div class="info-row">
                        <span class="info-label">Tack RPM:</span>
                        <span class="info-value">${point.measurements.tackRPM}</span>
                    </div>
                `;
            }
            
            html += `
                <div class="info-row">
                    <span class="info-label">Notes:</span>
                    <span class="info-value">${point.notes || 'None'}</span>
                </div>
            `;
            
            if (point.additionalNotes) {
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                        <strong>Additional Notes History:</strong><br>
                        ${point.additionalNotes.map(n => 
                            `<div style="margin-top: 5px; padding: 5px; border-left: 3px solid #667eea;">
                                ${n.note}<br>
                                <small style="color: #999;">${new Date(n.timestamp).toLocaleString()}</small>
                            </div>`
                        ).join('')}
                    </div>
                `;
            }
            
            body.innerHTML = html;
            document.getElementById('additional-notes').value = '';
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('point-modal').classList.remove('active');
            currentPointId = null;
        }
        
        function saveAdditionalNotes() {
            const notes = document.getElementById('additional-notes').value.trim();
            if (!notes || !currentPointId) return;
            
            const inspection = inspections.find(i => i.id === currentPointId);
            if (!inspection) return;
            
            if (!inspection.additionalNotes) {
                inspection.additionalNotes = [];
            }
            
            inspection.additionalNotes.push({
                note: notes,
                timestamp: new Date().toISOString()
            });
            
            inspection.history.push({
                action: 'notes_added',
                timestamp: new Date().toISOString()
            });
            
            saveData();
            syncToCloud(inspection);
            closeModal();
            alert('Additional notes saved successfully!');
        }
        
        function renderLog() {
            const container = document.getElementById('log-container');
            
            if (inspections.length === 0) {
                container.innerHTML = '<p>No inspection data available.</p>';
                return;
            }
            
            const sorted = [...inspections].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Inspector</th>
                            <th>Line</th>
                            <th>Downline</th>
                            <th>Machine</th>
                            <th>Point</th>
                            <th>Temp</th>
                            <th>Vib X/Y/Z</th>
                            <th>Sounds</th>
                            <th>RPM</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach(i => {
                const temp = i.measurements.temperature !== undefined ? i.measurements.temperature : '<span class="na-badge">N/A</span>';
                
                let vib = '';
                if (i.measurements.vibration) {
                    const vx = i.measurements.vibration.x !== undefined ? i.measurements.vibration.x.toFixed(2) : '-';
                    const vy = i.measurements.vibration.y !== undefined ? i.measurements.vibration.y.toFixed(2) : '-';
                    const vz = i.measurements.vibration.z !== undefined ? i.measurements.vibration.z.toFixed(2) : '-';
                    vib = `${vx}/${vy}/${vz}`;
                } else {
                    vib = '<span class="na-badge">N/A</span>';
                }
                
                const sounds = i.measurements.auditory && i.measurements.auditory.length > 0 
                    ? i.measurements.auditory.length + ' detected' 
                    : '<span class="na-badge">N/A</span>';
                
                const rpm = i.measurements.tackRPM !== undefined ? i.measurements.tackRPM : '<span class="na-badge">N/A</span>';
                const downline = i.downline || '<span class="na-badge">N/A</span>';
                
                html += `
                    <tr>
                        <td>${new Date(i.timestamp).toLocaleString()}</td>
                        <td>${i.inspector}</td>
                        <td>${i.line}</td>
                        <td>${downline}</td>
                        <td>${i.machine}</td>
                        <td>${i.inspectionPoint}</td>
                        <td>${temp}</td>
                        <td>${vib}</td>
                        <td>${sounds}</td>
                        <td>${rpm}</td>
                        <td>
                            <button class="btn-small btn-secondary" onclick="viewInspection('${i.id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function viewInspection(id) {
            const inspection = inspections.find(i => i.id === id);
            if (inspection) {
                showPointDetails(inspection);
            }
        }
        
        document.getElementById('line').addEventListener('change', updateInspectionPointOptions);
        document.getElementById('downline').addEventListener('change', updateInspectionPointOptions);
        document.getElementById('machine').addEventListener('change', updateInspectionPointOptions);

    </script>
</body>
</html>